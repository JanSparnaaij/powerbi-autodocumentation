name: Generate Power BI Documentation

on:
  push:
    paths:
      - '**.pbix'
      - '**.pbip'
      - '.github/workflows/generate-wiki.yml'
  workflow_dispatch:
    inputs:
      pbix_path:
        description: 'Path to PBIX file or PBIP folder'
        required: true
        default: './models/Fabrikam Company Sales Report.pbix'

jobs:
  generate-docs:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          git clone https://github.com/jonaolden/pbixray-mcp-server.git
          cd pbixray-mcp-server
          pip install -e .
          cd ..
          
      - name: Verify installation
        run: |
          echo "Python packages:"
          pip list | grep -E "(pbix|mcp)"
          echo "Checking pbixray-mcp-server structure:"
          ls -la pbixray-mcp-server/
          echo "Python path:"
          python -c "import sys; print('\n'.join(sys.path))"
      
      - name: Find PBIX files
        id: find-pbix
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "${{ github.event.inputs.pbix_path }}" > /tmp/pbix_files.txt
          else
            # Find changed PBIX files and PBIP folders in the push
            changed=$(git diff --name-only HEAD^ HEAD | grep -E '\.(pbix|pbip)$' || true)
            
            > /tmp/pbix_files.txt  # Clear file
            
            for file in $changed; do
              if [[ "$file" == *.pbix ]]; then
                # PBIX file - add directly
                echo "$file" >> /tmp/pbix_files.txt
              elif [[ "$file" == *.pbip ]]; then
                # PBIP file - find the .SemanticModel or .Dataset folder
                pbip_dir=$(dirname "$file")
                dataset_dir=$(find "$pbip_dir" -type d \( -name "*.SemanticModel" -o -name "*.Dataset" \) | head -1)
                if [ -n "$dataset_dir" ]; then
                  echo "$dataset_dir" >> /tmp/pbix_files.txt
                fi
              fi
            done
            
            if [ ! -s /tmp/pbix_files.txt ]; then
              # No changed files, find all
              echo "No changed PBIX/PBIP files detected, processing all"
              find . -name "*.pbix" -type f -not -path "*/pbixray-mcp-server/*" > /tmp/pbix_files.txt
              find . -type d \( -name "*.SemanticModel" -o -name "*.Dataset" \) -not -path "*/pbixray-mcp-server/*" >> /tmp/pbix_files.txt
            else
              echo "Found changed PBIX/PBIP files:"
              cat /tmp/pbix_files.txt
            fi
          fi
      
      - name: Generate wiki
        run: |
          # Process each PBIX/PBIP file (handles filenames with spaces)
          while IFS= read -r pbix; do
            if [ -f "$pbix" ] && [[ "$pbix" == *.pbix ]]; then
              echo "Processing PBIX: $pbix"
              python generate_wiki.py "$pbix" -o ./docs
            elif [ -d "$pbix" ]; then
              echo "⚠️  Skipping PBIP folder: $pbix (PBIP format not yet supported by pbixray-mcp-server)"
            fi
          done < /tmp/pbix_files.txt
      
      - name: Commit and push documentation
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/
          git commit -m "Auto-update documentation from ${{ github.sha }}" || echo "No changes to commit"
          git push origin main
